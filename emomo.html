<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¨ãƒ¢ãƒ¢ã‚¤ãƒ™ãƒ³ãƒˆ</title>
  <style>
    :root{
      --bg:#f5f5f5;
      --card:#ffffff;
      --text:#222;
      --muted:#666;
      --border:#ccc;
      --accent:#333;
      --btn:#eee;
      --shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    body.dark{
      --bg:#0f1115;
      --card:#151922;
      --text:#e6e6e6;
      --muted:#a3a3a3;
      --border:#2b2f3a;
      --accent:#7aa2f7;
      --btn:#1b2030;
      --shadow:0 2px 10px rgba(0,0,0,0.35);
    }

    body {
      font-family: sans-serif;
      margin: 0;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color .2s, color .2s;
    }

    header {
      background-color: var(--accent);
      padding: 12px;
      text-align: center;
      color: white;
      font-size: 1.3em;
    }

    nav {
      text-align: center;
      margin: 10px 0;
    }

    nav a {
      color: var(--accent);
      font-weight: bold;
      text-decoration: none;
      font-size: 1.1em;
    }

    main {
      max-width: 960px;
      margin: 0 auto;
      background-color: var(--card);
      padding: 20px;
      border-radius: 8px;
      box-shadow: var(--shadow);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 15px;
    }

    .controls input,
    .controls select,
    .controls button {
      padding: 8px;
      font-size: 14px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--card);
      color: var(--text);
    }

    .toggle.active {
      background-color: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .tab-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      margin-bottom: 15px;
    }

    .tab-buttons button {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background-color: var(--btn);
      color: var(--text);
      cursor: pointer;
    }

    .tab-buttons button.active {
      background-color: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .event-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
    }

    .event-card {
      border-radius: 8px;
      overflow: hidden;
      text-align: center;
    }

    .event-card img {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 6px;
      display:block;
    }

    .event-card div {
      display: none; /* ã‚¿ã‚¤ãƒˆãƒ«éè¡¨ç¤ºï¼ˆalt/titleã§è¦‹ãˆã‚‹ï¼‰ */
    }

    /* ğŸ” æ¤œç´¢å€™è£œï¼ˆäºˆå‚™æ¤œç´¢ï¼‰ */
    .search-wrap { position: relative; min-width: 260px; }
    #suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-top: none;
      max-height: 220px;
      overflow-y: auto;
      z-index: 20;
      display: none;
    }
    #suggestions button{
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--border);
      padding: 8px 10px;
      cursor: pointer;
      color: var(--text);
    }
    #suggestions button:hover{ background: var(--btn); }

    .muted{ color: var(--muted); font-size: 12px; }

    @media (max-width: 600px) {
      .controls {
        flex-direction: column;
        align-items: center;
      }
      .search-wrap{ width: 100%; }
    }
  </style>
</head>
<body>

<header>ã‚¨ãƒ¢ãƒ¢ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</header>
<nav><a href="index.html">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a></nav>

<main>
  <div class="controls">
    <div class="search-wrap">
      <input type="text" id="search" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ (ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Š)">
      <div id="suggestions"></div>
    </div>

    <button id="andBtn" class="toggle">AND</button>
    <button id="orBtn" class="toggle">OR</button>

    <select id="sortSelect" title="ä¸¦ã³æ›¿ãˆ">
      <option value="newest">æ–°ã—ã„é †</option>
      <option value="oldest">å¤ã„é †</option>
    </select>

    <select id="filterSelect" title="ã‚«ãƒ†ã‚´ãƒªçµã‚Šè¾¼ã¿">
      <option value="">å…¨ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
      <option value="ãƒ«ãƒ¬">ãƒ«ãƒ¬ã ã‘</option>
      <option value="ã‚®ãƒ•ã‚¬ãƒãƒ£">ã‚®ãƒ•ã‚¬ãƒãƒ£ã ã‘</option>
      <option value="ã‚¨ãƒ¢ãƒãƒˆ">ã‚¨ãƒ¢ãƒãƒˆã ã‘</option>
      <option value="ã‚¨ãƒ¢ãƒ©ãƒ³">ã‚¨ãƒ¢ãƒ©ãƒ³ã ã‘</option>
    </select>

    <button id="themeToggle" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</button>
  </div>

  <div class="tab-buttons" id="yearTabs"></div>
  <div class="event-grid" id="eventList">èª­ã¿è¾¼ã¿ä¸­...</div>
  <p class="muted" id="hint"></p>
</main>

<script>
  // ====== çŠ¶æ…‹ ======
  let data = {};
  let currentYear = "2025";
  let searchMode = ""; // "", "AND", "OR"
  let allEvents = [];  // æ­£è¦åŒ–å¾Œã®å…¨ã‚¤ãƒ™ãƒ³ãƒˆ
  let allKeywords = new Set(); // å€™è£œè¡¨ç¤ºç”¨
  let allTitles = new Set();   // å€™è£œè¡¨ç¤ºç”¨

  // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
  (function initTheme(){
    const saved = localStorage.getItem("emomo_theme");
    if(saved === "dark"){ document.body.classList.add("dark"); }
  })();

  // ====== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ======
  fetch("data/events.json")
    .then(res => res.json())
    .then(json => {
      data = json;
      flattenAndNormalize();
      initYearTabs();
      initControls();
      renderEvents();
    })
    .catch(err=>{
      console.error(err);
      document.getElementById("eventList").innerHTML = "<p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
    });

  // å¹´ã‚­ãƒ¼ä»˜ãã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã€yearã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—(ts)ã‚’ä»˜ã‘ã¦ãƒ•ãƒ©ãƒƒãƒˆåŒ–
  function flattenAndNormalize(){
    allEvents = [];
    for(const y in data){
      (data[y]||[]).forEach(ev=>{
        const copy = {...ev};
        copy.year = y;
        copy.ts = normalizeDateToTs(copy, y); // ä¸¦ã³æ›¿ãˆç”¨timestamp
        // å€™è£œåé›†
        if (copy.title) allTitles.add(copy.title);
        if (Array.isArray(copy.keywords)) copy.keywords.forEach(k=>allKeywords.add(k));
        allEvents.push(copy);
      });
    }
  }

  // ====== æ—¥ä»˜æ­£è¦åŒ–ï¼ˆã‚½ãƒ¼ãƒˆã®è¦ï¼šã“ã“ãŒã‚­ãƒ¢ï¼ï¼‰ ======
  // ã§ãã‚Œã° ev.date ã¯ "YYYY-MM-DD" ã‚’æ¨å¥¨ã€‚
  // ç„¡ã„å ´åˆã¯ title/keywords ã‹ã‚‰æ¨å®šã—ã€æœ€å¾Œã« year ã ã‘ã§ã‚‚è£œå®Œã€‚
  function normalizeDateToTs(ev, fallbackYear){
    // 1) æ˜ç¤ºçš„ãª date
    if(typeof ev.date === "string"){
      const d = parseISOish(ev.date);
      if(d) return d.getTime();
    }
    // 2) ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ "YYYY-MM-DD" / "YYYY/MM/DD" / "YYYYå¹´MæœˆDæ—¥" ã‚’æ¤œç´¢
    if(typeof ev.title === "string"){
      const dFromTitle = extractDateFromText(ev.title);
      if(dFromTitle) return dFromTitle.getTime();
    }
    // 3) ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«å¹´ãŒã‚ã‚Œã°ã€ã‚¿ã‚¤ãƒˆãƒ«ã® "M/D" ãªã©ã¨åˆæˆ
    const kwYear = Array.isArray(ev.keywords) ? ev.keywords.find(k=>/^\d{4}$/.test(k)) : null;
    if(kwYear && typeof ev.title === "string"){
      const md = ev.title.match(/(\d{1,2})[\/\-æœˆ](\d{1,2})/); // "1/31" or "1-31" or "1æœˆ31"
      if(md){
        const y = Number(kwYear);
        const m = Number(md[1]);
        const d = Number(md[2]);
        const dt = new Date(Date.UTC(y, m-1, d));
        return dt.getTime();
      }
    }
    // 4) ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰ã€ãã®å¹´ã®1æœˆ1æ—¥ã‚’ä»®ç½®ã
    const y = Number(fallbackYear) || new Date().getUTCFullYear();
    return new Date(Date.UTC(y,0,1)).getTime();
  }

  // "YYYY-MM-DD" / "YYYY/MM/DD" / "YYYY.MM.DD" å¯¾å¿œ
  function parseISOish(s){
    const m = s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$/);
    if(!m) return null;
    const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
    if(!y || !mo || !d) return null;
    return new Date(Date.UTC(y, mo-1, d));
  }

  // æ—¥æœ¬èªè¡¨è¨˜ãªã©ã‚‚å«ã‚ç·©ã‚ã«æ‹¾ã†
  function extractDateFromText(t){
    // ä¾‹: 2025-02-15 / 2025/02/15 / 2025.2.15
    const a = t.match(/(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})/);
    if(a){
      return new Date(Date.UTC(+a[1], +a[2]-1, +a[3]));
    }
    // ä¾‹: 2025å¹´2æœˆ15æ—¥ / 2025å¹´2æœˆ
    const b = t.match(/(\d{4})\s*å¹´\s*(\d{1,2})\s*æœˆ(?:\s*(\d{1,2})\s*æ—¥)?/);
    if(b){
      const y = +b[1], m = +b[2], d = b[3]? +b[3] : 1;
      return new Date(Date.UTC(y, m-1, d));
    }
    return null;
    // ï¼ˆå¿…è¦ãªã‚‰ãƒ‘ã‚¿ãƒ¼ãƒ³è¿½åŠ å¯ï¼‰
  }

  // ====== å¹´ã‚¿ãƒ– ======
  function initYearTabs() {
    const tabContainer = document.getElementById("yearTabs");
    const years = Object.keys(data).sort((a, b) => b - a);
    tabContainer.innerHTML = "";

    const allBtn = document.createElement("button");
    allBtn.textContent = "ã™ã¹ã¦";
    allBtn.className = currentYear === "all" ? "active" : "";
    allBtn.addEventListener("click", () => {
      currentYear = "all";
      tabContainer.querySelectorAll("button").forEach(b => b.classList.remove("active"));
      allBtn.classList.add("active");
      renderEvents();
    });
    tabContainer.appendChild(allBtn);

    years.forEach(year => {
      const btn = document.createElement("button");
      btn.textContent = year + "å¹´";
      btn.className = year === currentYear ? "active" : "";
      btn.addEventListener("click", () => {
        currentYear = year;
        tabContainer.querySelectorAll("button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        renderEvents();
      });
      tabContainer.appendChild(btn);
    });
  }

  // ====== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆAND/ORãƒ»ã‚½ãƒ¼ãƒˆãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ»ãƒ€ãƒ¼ã‚¯ï¼‰ ======
  function initControls(){
    const $and = document.getElementById("andBtn");
    const $or = document.getElementById("orBtn");
    const $sort = document.getElementById("sortSelect");
    const $filter = document.getElementById("filterSelect");
    const $search = document.getElementById("search");
    const $suggest = document.getElementById("suggestions");
    const $theme = document.getElementById("themeToggle");

    // AND/ORï¼ˆãƒˆã‚°ãƒ«&æ’ä»–ãƒ»ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨è§£é™¤ï¼‰
    $and.addEventListener("click", ()=>{
      searchMode = (searchMode==="AND") ? "" : "AND";
      $and.classList.toggle("active", searchMode==="AND");
      $or.classList.remove("active");
      renderEvents();
    });
    $or.addEventListener("click", ()=>{
      searchMode = (searchMode==="OR") ? "" : "OR";
      $or.classList.toggle("active", searchMode==="OR");
      $and.classList.remove("active");
      renderEvents();
    });

    // ã‚½ãƒ¼ãƒˆãƒ»ã‚«ãƒ†ã‚´ãƒª
    $sort.addEventListener("change", renderEvents);
    $filter.addEventListener("change", renderEvents);

    // æ¤œç´¢å…¥åŠ›ï¼ˆã‚¿ã‚¤ãƒ—ä¸­ã«å³æ™‚çµã‚Šè¾¼ã¿ï¼‰
    $search.addEventListener("input", ()=>{
      showSuggestions($search.value);
      renderEvents();
    });
    $search.addEventListener("focus", ()=>{
      // äºˆå‚™æ¤œç´¢ï¼šæœªå…¥åŠ›ãªã‚‰äººæ°—ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
      if(!$search.value.trim()) showSuggestions("");
    });
    document.addEventListener("click", (e)=>{
      if(!e.target.closest(".search-wrap")) $suggest.style.display = "none";
    });

    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    $theme.addEventListener("click", ()=>{
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      localStorage.setItem("emomo_theme", isDark ? "dark" : "light");
      $theme.textContent = isDark ? "â˜€ï¸ ãƒ©ã‚¤ãƒˆ" : "ğŸŒ™ ãƒ€ãƒ¼ã‚¯";
    });
    // åˆæœŸãƒœã‚¿ãƒ³è¡¨è¨˜
    document.getElementById("themeToggle").textContent =
      document.body.classList.contains("dark") ? "â˜€ï¸ ãƒ©ã‚¤ãƒˆ" : "ğŸŒ™ ãƒ€ãƒ¼ã‚¯";
  }

  // ====== æ¤œç´¢å€™è£œï¼ˆäºˆå‚™æ¤œç´¢ï¼‰ ======
  function showSuggestions(input){
    const box = document.getElementById("suggestions");
    const q = input.trim().toLowerCase();
    let items = [];

    if(q){
      // å…¥åŠ›ä¸­ï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ & ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰éƒ¨åˆ†ä¸€è‡´ã§å€™è£œ
      const kw = Array.from(allKeywords).filter(k=>k.toLowerCase().includes(q));
      const tt = Array.from(allTitles).filter(t=>t.toLowerCase().includes(q));
      items = [...kw.slice(0,10), ...tt.slice(0,10)];
    }else{
      // äºˆå‚™æ¤œç´¢ï¼šé »å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸Šä½ã‚’è¡¨ç¤ºï¼ˆã–ã£ãã‚Šé »åº¦ã‚«ã‚¦ãƒ³ãƒˆï¼‰
      const freq = {};
      allEvents.forEach(ev=>{
        (ev.keywords||[]).forEach(k=>{ freq[k]=(freq[k]||0)+1; });
      });
      items = Object.entries(freq)
        .sort((a,b)=>b[1]-a[1])
        .slice(0,10)
        .map(([k])=>k);
    }

    if(items.length===0){
      box.style.display = "none";
      box.innerHTML = "";
      return;
    }
    box.innerHTML = items.map(txt => `<button type="button">${escapeHtml(txt)}</button>`).join("");
    box.style.display = "block";

    // å€™è£œã‚¯ãƒªãƒƒã‚¯ã§æ¤œç´¢æ¬„ã«åæ˜ ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã§è¤‡æ•°èªã«ç¹‹ã’ã‚‰ã‚Œã‚‹ï¼‰
    box.querySelectorAll("button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const $search = document.getElementById("search");
        const cur = $search.value.trim();
        $search.value = cur ? (cur + " " + btn.textContent) : btn.textContent;
        $search.dispatchEvent(new Event("input"));
        box.style.display = "none";
      });
    });
  }

  function escapeHtml(s){
    return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  }

  // ====== æç”» ======
  function renderEvents() {
    const list = document.getElementById("eventList");
    const hint = document.getElementById("hint");

    const searchWords = document.getElementById("search").value
      .trim().toLowerCase().split(/\s+/).filter(Boolean);
    const sortBy = document.getElementById("sortSelect").value; // newest|oldest
    const category = document.getElementById("filterSelect").value.toLowerCase();

    // æ¤œç´¢ & ãƒ•ã‚£ãƒ«ã‚¿
    let filtered = allEvents.filter(ev => {
      const title = (ev.title||"").toLowerCase();
      const keys = (ev.keywords||[]).map(k=>k.toLowerCase());

      const keywordMatch =
        searchWords.length === 0 || (
          searchMode === "AND"
            ? searchWords.every(w => title.includes(w) || keys.some(k => k.includes(w)))
            : searchMode === "OR"
              ? searchWords.some(w => title.includes(w) || keys.some(k => k.includes(w)))
              : true
        );

      const categoryMatch = !category || keys.includes(category);

      const yearMatch = (currentYear==="all") ? true : (ev.year === currentYear);

      return keywordMatch && categoryMatch && yearMatch;
    });

    // ä¸¦ã³æ›¿ãˆï¼ˆäº‹å‰è¨ˆç®—ã—ãŸ ts ã‚’ä½¿ç”¨ï¼šæ­£ç¢ºï¼†é«˜é€Ÿï¼‰
    filtered.sort((a,b)=> sortBy==="newest" ? (b.ts - a.ts) : (a.ts - b.ts));

    // ãƒ’ãƒ³ãƒˆè¡¨ç¤º
    hint.textContent = `${filtered.length}ä»¶ãƒ’ãƒƒãƒˆ / ä¸¦ã³: ${sortBy==="newest"?"æ–°ã—ã„é †":"å¤ã„é †"} / å¹´: ${currentYear==="all"?"ã™ã¹ã¦":currentYear}`;

    // æç”»
    if (filtered.length === 0) {
      list.innerHTML = "<p>è©²å½“ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    } else {
      list.innerHTML = filtered.map(ev => `
        <div class="event-card">
          <a href="${ev.link}" target="_blank" title="${escapeHtml(ev.title||"")}">
            <img src="${ev.img}" alt="${escapeHtml(ev.title||"")}">
            <div>${escapeHtml(ev.title||"")}</div>
          </a>
        </div>
      `).join('');
    }
  }
</script>

</body>
</html>
