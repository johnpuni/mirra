<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>エモモイベント一覧</title>
<style>
  body {
    font-family: sans-serif;
    margin: 0;
    background: #f5f5f5;
  }
  header {
    background: #333;
    color: #fff;
    padding: 12px;
    text-align: center;
    font-size: 1.3em;
  }
  nav {
    text-align: center;
    margin: 15px 0;
  }
  nav a {
    color: #333;
    font-weight: bold;
    text-decoration: none;
    margin: 0 15px;
    font-size: 1.1em;
  }
  main {
    max-width: 900px;
    margin: 0 auto 40px;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
  }
  .tab-buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
  }
  .tab-buttons button {
    background: #eee;
    border: 1px solid #ccc;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
  }
  .tab-buttons button.active {
    background-color: #333;
    color: #fff;
    border-color: #333;
  }

  .filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 20px;
    justify-content: center;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  .filter-group label {
    font-weight: bold;
  }
  .filter-group button {
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #eee;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s;
  }
  .filter-group button.active {
    background: #333;
    color: #fff;
    border-color: #333;
  }

  #search-container {
    position: relative;
    width: 100%;
    max-width: 400px;
    margin: 0 auto 30px;
  }
  #search {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  #suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-top: none;
    max-height: 150px;
    overflow-y: auto;
    z-index: 1000;
  }
  #suggestions div {
    padding: 8px 12px;
    cursor: pointer;
  }
  #suggestions div:hover {
    background-color: #eee;
  }

  .tab-content {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
    gap: 16px;
  }
  .event-card {
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 5px rgb(0 0 0 / 0.1);
    background: #fff;
    transition: box-shadow 0.3s;
  }
  .event-card:hover {
    box-shadow: 0 4px 12px rgb(0 0 0 / 0.2);
  }
  .event-card img {
    width: 100%;
    display: block;
    border-bottom: 1px solid #ddd;
    border-radius: 8px 8px 0 0;
  }
  .event-card a {
    display: block;
    padding: 8px 10px;
    color: #333;
    text-decoration: none;
    font-weight: 600;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .event-card a:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<header>エモモイベント一覧</header>
<nav><a href="index.html">← ホームに戻る</a></nav>

<main>
  <!-- 年タブ -->
  <div class="tab-buttons" id="yearTabs">
    <!-- JSで年ボタン生成 -->
  </div>

  <!-- フィルター群 -->
  <div class="filter-row">
    <!-- AND/OR切替 -->
    <div class="filter-group" id="andOrGroup">
      <label>検索モード:</label>
      <button id="andBtn" class="active">AND</button>
      <button id="orBtn">OR</button>
    </div>

    <!-- 並び替え -->
    <div class="filter-group" id="sortGroup">
      <label for="sortSelect">並び替え:</label>
      <select id="sortSelect" aria-label="並び替え">
        <option value="newest">新しい順</option>
        <option value="oldest">古い順</option>
      </select>
    </div>

    <!-- カテゴリ絞り込み -->
    <div class="filter-group" id="categoryGroup">
      <label>カテゴリ絞り込み:</label>
      <button data-category="all" class="active">全て</button>
      <button data-category="ルレ">ルレだけ</button>
      <button data-category="ギフガチャ">ギフガチャだけ</button>
      <button data-category="エモバト">エモバトだけ</button>
      <button data-category="エモラン">エモランだけ</button>
    </div>
  </div>

  <!-- 検索ボックス + 入力補助 -->
  <div id="search-container">
    <input type="text" id="search" placeholder="イベントを検索（例: 夏、限定、復刻、10周年）" autocomplete="off" aria-label="イベント検索">
    <div id="suggestions" hidden></div>
  </div>

  <!-- イベント表示エリア -->
  <div class="tab-content" id="tabContent">
    <p>読み込み中...</p>
  </div>
</main>

<script>
(() => {
  const yearTabs = document.getElementById('yearTabs');
  const tabContent = document.getElementById('tabContent');
  const searchInput = document.getElementById('search');
  const suggestionsBox = document.getElementById('suggestions');
  const andBtn = document.getElementById('andBtn');
  const orBtn = document.getElementById('orBtn');
  const sortSelect = document.getElementById('sortSelect');
  const categoryGroup = document.getElementById('categoryGroup');

  // 使用する年リスト（ここは必要に応じて増減してください）
  const years = ['2025', '2024', '2023', '2022', '2021', '2020', '2019'];

  // グローバル変数：読み込んだイベントデータ
  let eventData = {};
  let currentYear = '2025';
  let currentCategory = 'all';
  let currentAndOr = 'AND';

  // 全イベントの配列キャッシュ（年度関係なく検索用に使う）
  let allEventsFlat = [];

  // 年タブの初期生成
  function createYearTabs() {
    years.forEach(y => {
      const btn = document.createElement('button');
      btn.textContent = y + '年';
      btn.dataset.year = y;
      if (y === currentYear) btn.classList.add('active');
      btn.addEventListener('click', () => {
        currentYear = y;
        clearSearch();
        updateYearTabs();
        renderEvents();
      });
      yearTabs.appendChild(btn);
    });
  }
  function updateYearTabs() {
    yearTabs.querySelectorAll('button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.year === currentYear);
    });
  }

  // AND/OR切り替えボタンイベント
  andBtn.addEventListener('click', () => {
    currentAndOr = 'AND';
    andBtn.classList.add('active');
    orBtn.classList.remove('active');
    renderEvents();
  });
  orBtn.addEventListener('click', () => {
    currentAndOr = 'OR';
    orBtn.classList.add('active');
    andBtn.classList.remove('active');
    renderEvents();
  });

  // 並び替えセレクト変更イベント
  sortSelect.addEventListener('change', () => {
    renderEvents();
  });

  // カテゴリボタン群イベント
  categoryGroup.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', () => {
      currentCategory = btn.dataset.category;
      categoryGroup.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderEvents();
    });
  });

  // 検索文字列変更イベント（入力補助兼ねる）
  searchInput.addEventListener('input', () => {
    const val = searchInput.value.trim().toLowerCase();
    updateSuggestions(val);
    renderEvents();
  });

  // 入力補助（検索候補）更新
  function updateSuggestions(keyword) {
    if (!keyword) {
      suggestionsBox.hidden = true;
      suggestionsBox.innerHTML = '';
      return;
    }
    const suggestions = allEventsFlat
      .filter(e => e.title.toLowerCase().includes(keyword))
      .slice(0, 10);

    if (suggestions.length === 0) {
      suggestionsBox.hidden = true;
      suggestionsBox.innerHTML = '';
      return;
    }

    suggestionsBox.innerHTML = '';
    suggestions.forEach(e => {
      const div = document.createElement('div');
      div.textContent = e.title;
      div.title = e.title;
      div.tabIndex = 0;
      div.addEventListener('click', () => {
        searchInput.value = e.title;
        suggestionsBox.hidden = true;
        renderEvents();
      });
      div.addEventListener('keydown', (ev) => {
        if (ev.key === "Enter") {
          searchInput.value = e.title;
          suggestionsBox.hidden = true;
          renderEvents();
        }
      });
      suggestionsBox.appendChild(div);
    });
    suggestionsBox.hidden = false;
  }

  // 年をまたぐ全イベント配列を作成
  function flattenEvents(data) {
    let arr = [];
    Object.values(data).forEach(arrYear => {
      if(Array.isArray(arrYear)) arr = arr.concat(arrYear);
    });
    return arr;
  }

  // イベント表示
  function renderEvents() {
    let eventsToShow = [];

    const searchWords = searchInput.value.trim().toLowerCase().split(/\s+/).filter(Boolean);

    // 検索が空欄なら年タブのイベントだけ表示
    if (searchWords.length === 0) {
      eventsToShow = eventData[currentYear] || [];
    } else {
      // 全年度のイベントからAND/OR検索
      if (currentAndOr === 'AND') {
        eventsToShow = allEventsFlat.filter(ev => {
          return searchWords.every(word => 
            ev.title.toLowerCase().includes(word) || 
            (ev.keywords && ev.keywords.some(k => k.toLowerCase().includes(word)))
          );
        });
      } else {
        eventsToShow = allEventsFlat.filter(ev => {
          return searchWords.some(word => 
            ev.title.toLowerCase().includes(word) || 
            (ev.keywords && ev.keywords.some(k => k.toLowerCase().includes(word)))
          );
        });
      }
    }

    // カテゴリ絞り込み
    if (currentCategory !== 'all') {
      eventsToShow = eventsToShow.filter(ev => {
        if(!ev.keywords) return false;
        return ev.keywords.some(k => k.includes(currentCategory));
      });
    }

    // 並び替え
    eventsToShow.sort((a,b) => {
      // IDっぽい数字を抜き出して比較（linkのc=の値）
      const aNum = extractLinkId(a.link);
      const bNum = extractLinkId(b.link);
      if(sortSelect.value === 'newest') {
        return bNum - aNum;
      } else {
        return aNum - bNum;
      }
    });

    // 表示処理
    if(eventsToShow.length === 0) {
      tabContent.innerHTML = '<p>該当するイベントはありません。</p>';
      return;
    }

    tabContent.innerHTML = eventsToShow.map(ev => {
      return `
        <div class="event-card" title="${escapeHtml(ev.title)}">
          <a href="${ev.link}" target="_blank" rel="noopener noreferrer">
            <img src="${escapeHtml(ev.img)}" alt="${escapeHtml(ev.title)}" loading="lazy" />
            <div class="event-title">${escapeHtml(ev.title)}</div>
          </a>
        </div>
      `;
    }).join('');
  }

  // リンクID抽出
  function extractLinkId(link) {
    try {
      const match = link.match(/c=(\d+)/);
      return match ? Number(match[1]) : 0;
    } catch {
      return 0;
    }
  }

  // HTMLエスケープ（タイトルなどに安全のため）
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    })[m]);
  }

  // 検索ボックス外クリックで候補非表示
  document.addEventListener('click', e => {
    if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
      suggestionsBox.hidden = true;
    }
  });

  // 検索クリア
  function clearSearch() {
    searchInput.value = '';
    suggestionsBox.hidden = true;
  }

  // JSON読み込みと初期化
  fetch('data/events.json')
    .then(res => res.json())
    .then(json => {
      eventData = json;
      allEventsFlat = flattenEvents(eventData);
      createYearTabs();
      renderEvents();
    })
    .catch(err => {
      tabContent.innerHTML = '<p>イベントデータの読み込みに失敗しました。</p>';
      console.error('読み込み失敗:', err);
    });
})();
</script>

</body>
</html>
