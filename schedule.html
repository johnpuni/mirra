<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Mirrativ Event Schedule</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#0e0e11;color:#fff;margin:0;padding:0;user-select:none;}
h1{text-align:center;margin:16px 0;}
#tabs{display:flex;justify-content:center;flex-wrap:wrap;margin-bottom:8px;}
.tab{padding:6px 12px;margin:2px;border-radius:6px;background:#222;cursor:pointer;transition:0.3s;}
.tab.active{background:#ff0;color:#000;font-weight:bold;}
#schedule{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:12px;}
.card{background:#1a1b20;border-radius:14px;overflow:hidden;box-shadow:0 6px 14px rgba(0,0,0,.4);transition:transform .3s,box-shadow .3s;position:relative;padding-bottom:28px;}
.card:hover{transform:scale(1.03);box-shadow:0 12px 20px rgba(0,0,0,.5);}
.image-box{position:relative;cursor:pointer;overflow:hidden;width:100%;}
.image-box img{width:100%;height:auto;display:block;}
.time-circle{position:absolute;top:6px;right:6px;width:48px;height:48px;background:rgba(255,255,255,0.8);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;color:#000;text-align:center;line-height:1.2;pointer-events:none;}
.open-btn{position:absolute;bottom:8px;right:8px;background:#ff0;color:#000;font-weight:bold;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:14px;z-index:2;}
.open-btn:hover{background:#ffd;}

/* ✅ 追加：プレビュー按钮 */
.preview-btn{
  position:absolute;bottom:8px;right:74px;
  background:#0ff;color:#000;font-weight:bold;
  padding:6px 10px;border-radius:8px;cursor:pointer;
  font-size:14px;z-index:2;
}
.preview-btn:hover{background:#cfffff;}

.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:999;display:none;}
.modal{position:relative;background:#000;border-radius:12px;max-width:90%;max-height:90%;overflow:hidden;display:flex;align-items:center;justify-content:center;flex-direction:column;}
.modal img{max-width:100%;max-height:100%;object-fit:contain;margin-bottom:8px;border-radius:6px;}
.close-btn{position:absolute;top:10px;right:10px;font-size:36px;font-weight:bold;color:#fff;background:rgba(0,0,0,.5);padding:6px 12px;border-radius:8px;cursor:pointer;z-index:3;}
.modal-buttons{display:flex;gap:8px;margin-bottom:6px;flex-wrap:wrap;justify-content:center;}
.modal-buttons button{padding:8px 14px;border:none;border-radius:6px;background:#ff0;color:#000;cursor:pointer;font-weight:bold;transition:0.2s;font-size:14px;}
.modal-buttons button.active{background:#ffd;font-weight:bold;}
.modal-buttons button:hover{background:#ffe;}
.loader{color:#fff;font-size:18px;text-align:center;}
@keyframes glow{0%{box-shadow:0 0 8px #0f0;}50%{box-shadow:0 0 20px #0f0;}100%{box-shadow:0 0 8px #0f0;}}
.glow{animation:glow 1.2s infinite;}
#pw-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:#111;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:1000;}
#pw-screen input{font-size:28px;padding:14px;margin:12px;border-radius:8px;border:none;text-align:center;width:260px;}
#pw-screen button{font-size:24px;padding:12px 18px;margin-top:12px;border-radius:8px;border:none;background:#ff0;color:#000;cursor:pointer;}
#pw-screen button:hover{background:#ffd;}
#pw-screen .info{text-align:center;margin-top:20px;font-size:16px;line-height:1.5;max-width:380px;}
#pw-screen #pw-version{position:absolute;bottom:10px;font-size:14px;color:#888;}
#screenshot-warning{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);color:#f00;display:flex;align-items:center;justify-content:center;text-align:center;font-size:24px;padding:20px;z-index:2000;display:none;}
#version{position:fixed;bottom:4px;right:8px;font-size:12px;color:#888;}

/* ✅ 追加：サイトプレビューモーダル */
.site-modal{
  position:relative;background:#000;border-radius:12px;
  width:92vw;height:92vh;max-width:92vw;max-height:92vh;
  overflow:hidden;display:flex;flex-direction:column;
}
.site-controls{
  display:flex;gap:8px;flex-wrap:wrap;justify-content:center;
  padding:10px;background:#111;
}
.site-controls button{
  padding:8px 14px;border:none;border-radius:6px;
  background:#ff0;color:#000;cursor:pointer;font-weight:bold;
  transition:0.2s;font-size:14px;
}
.site-controls button:hover{background:#ffe;}
#site-msg{display:none;color:#ff8080;padding:10px;text-align:center;font-weight:bold;}
#site-frame{flex:1;width:100%;border:none;background:#111;}
</style>
</head>
<body>

<div id="screenshot-warning">スクリーンショットは許可されていません！</div>

<div id="pw-screen">
<h1>リーク情報閲覧のためパスワードが必要です</h1>
<input type="password" id="pw" placeholder="Password">
<button onclick="checkPassword()">Enter</button>
<div class="info">このページには未公開情報・イベント内部情報が含まれています。<br>関係者以外の閲覧は禁止されています。</div>
<div id="pw-version">Version 1.4.0</div>
</div>

<h1>イベントスケジュール</h1>
<div id="tabs"></div>
<div id="schedule"></div>

<!-- 画像モーダル -->
<div class="overlay" id="modal">
  <div class="modal">
    <span class="close-btn" onclick="closeModal()">×</span>
    <img id="modal-img" src="" style="display:none;">
    <div class="loader" id="modal-loader">読み込み中...</div>
    <div class="modal-buttons" id="modal-btns"></div>
  </div>
</div>

<!-- ✅ サイトプレビューモーダル -->
<div class="overlay" id="site-modal">
  <div class="site-modal">
    <span class="close-btn" onclick="closeSiteModal()">×</span>
    <div class="site-controls">
      <button onclick="reloadSitePreview()">更新</button>
      <button onclick="openSiteExternal()">外部で開く</button>
      <button onclick="openSiteInApp()">アプリで開く</button>
    </div>
    <div id="site-msg"></div>
    <iframe id="site-frame"
      sandbox="allow-scripts allow-forms allow-same-origin allow-popups"
      referrerpolicy="no-referrer">
    </iframe>
  </div>
</div>

<div id="version">Version 1.4.0 / 更新日: 2026-01-06</div>

<script>
const VERSION = "1.4.0";
const PASSWORD = "wsama";

if(localStorage.getItem("pw_ok") !== "true_"+VERSION){
  document.getElementById("pw-screen").style.display="flex";
}else{
  document.getElementById("pw-screen").style.display="none";
}
function checkPassword(){
  if(document.getElementById("pw").value === PASSWORD){
    localStorage.setItem("pw_ok","true_"+VERSION);
    document.getElementById("pw-screen").style.display="none";
  }else{alert("パスワードが違います");}
}

function proxyImage(url){return "https://images.weserv.nl/?url="+encodeURIComponent(url.replace(/^https?:\/\//,""));}
function directLink(url){return "mirr://webview/window/open?url="+encodeURIComponent(url);}

/* =========================
   ✅ サイトプレビュー（HTMLだけで完結）
   - mirr:/// の一部は https に変換して iframe で表示を試す
   - 無理ならメッセージ + 外部/アプリボタン
========================= */
let currentRawUrl = "";
let currentHttpUrl = "";

function toHttpUrl(mirrUrl){
  if(!mirrUrl) return "";

  // 既にhttpsならそのまま
  if(/^https?:\/\//.test(mirrUrl)) return mirrUrl;

  // mirr:///xxxx -> https://www.mirrativ.com/xxxx （変換できる可能性があるものだけ）
  if(mirrUrl.startsWith("mirr:///")){
    const path = mirrUrl.replace(/^mirr:\/\/\//, "");
    // 例：notice/popup, notice/popup_click などはWebにも存在しがち
    // gift_ranking / roulette / emomo 系はWebで見れない可能性が高い（この場合は失敗扱いにする）
    if(path.startsWith("notice/") || path.startsWith("webview/")){
      return "https://www.mirrativ.com/" + path;
    }
    // 一応試す（表示できない可能性高いが、試す価値はある）
    return "https://www.mirrativ.com/" + path;
  }

  return "";
}

function openSiteModal(rawUrl){
  currentRawUrl = rawUrl || "";
  currentHttpUrl = toHttpUrl(currentRawUrl);

  const modal = document.getElementById("site-modal");
  const frame = document.getElementById("site-frame");
  const msg = document.getElementById("site-msg");

  // httpsが作れないならアウト
  if(!currentHttpUrl){
    msg.style.display="block";
    msg.textContent="このURLはブラウザ表示できません（httpsに変換できない）。「アプリで開く」を使ってください。";
    frame.src = "about:blank";
    modal.style.display="flex";
    return;
  }

  // iframeで読み込み試行
  msg.style.display="block";
  msg.textContent="プレビューを読み込み中…（表示されない場合は「外部で開く」 or 「アプリで開く」）";
  frame.src = currentHttpUrl;
  modal.style.display="flex";
}

function closeSiteModal(){
  document.getElementById("site-modal").style.display="none";
  document.getElementById("site-frame").src = "about:blank";
  document.getElementById("site-msg").style.display="none";
  currentRawUrl = "";
  currentHttpUrl = "";
}

function reloadSitePreview(){
  const frame = document.getElementById("site-frame");
  if(frame.src && frame.src !== "about:blank") frame.src = frame.src;
}

function openSiteExternal(){
  // httpsがあればそっち優先
  if(currentHttpUrl) window.open(currentHttpUrl, "_blank", "noopener");
}

function openSiteInApp(){
  if(!currentRawUrl) return;
  // アプリで確実に開く（あなたの既存ロジック利用）
  location.href = directLink(currentRawUrl);
}

// iframeが読み込めたらメッセージ消す（同一オリジンじゃない場合も onload は来ることが多い）
document.getElementById("site-frame").addEventListener("load", ()=>{
  const msg = document.getElementById("site-msg");
  if(msg) msg.style.display="none";
});

/* ========================= */

async function loadSchedule(){
  const listRes = await fetch("schedule/index.json");
  const files = await listRes.json();
  let events = [];
  for(const file of files){
    const data = await fetch("schedule/"+file).then(r=>r.json());
    events = events.concat(data);
  }
  const seen={};
  events = events.filter(e=>{
    const key=e.url+"|"+e.start+"|"+e.end;
    if(seen[key]) return false;
    seen[key]=true;
    return true;
  });
  const months=Array.from(new Set(events.map(e=>e.start.substr(0,7)))).sort();
  renderTabs(months,events);
}

function renderTabs(months,events){
  const tabsWrap=document.getElementById("tabs"); tabsWrap.innerHTML="";
  const nowMonth=new Date().toISOString().substr(0,7);
  months.forEach(m=>{
    const tab=document.createElement("div");
    tab.className="tab"+(m===nowMonth?" active":"");
    tab.textContent=m;
    tab.onclick=()=>{
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      tab.classList.add("active");
      render(events.filter(ev=>ev.start.substr(0,7)===m));
    };
    tabsWrap.appendChild(tab);
  });
  const initialMonth=months.includes(nowMonth)?nowMonth:months[months.length-1];
  render(events.filter(ev=>ev.start.substr(0,7)===initialMonth));
}

// カード描画
function render(events){
  const wrap=document.getElementById("schedule"); wrap.innerHTML="";
  const now=new Date();
  events.sort((a,b)=>new Date(a.start)-new Date(b.start));

  for(const e of events){
    const start=new Date(e.start), end=new Date(e.end);
    const card=document.createElement("div"); card.className="card";
    if(now>=start && now<=end) card.classList.add("glow");

    const box=document.createElement("div"); box.className="image-box";

    // 画像モーダル
    box.onclick=()=>{
      let hero = e.image ? e.image.replace("catalog_banner","hero") : null;
      openModal(hero, e.images, e);
    };

    if(e.image){
      const img=document.createElement("img"); img.src=proxyImage(e.image); box.appendChild(img);
    }else box.textContent="No Image";

    const circle=document.createElement("div"); circle.className="time-circle";
    if(now<start){circle.textContent="開始\n"+Math.ceil((start-now)/86400000)+"日"; circle.style.color="#00f";}
    else if(now>=start && now<=end){circle.textContent="終了\n"+Math.ceil((end-now)/86400000)+"日"; circle.style.color="red";}
    else{circle.textContent="終了"; circle.style.color="#888";}

    const dateText=document.createElement("div");
    dateText.style.textAlign="center"; dateText.style.fontSize="12px"; dateText.style.margin="6px 0 28px 0";
    dateText.textContent=`期間: ${e.start.substr(0,10)} ~ ${e.end.substr(0,10)}`;

    // ✅ サイトプレビュー（HTMLだけ）
    const preview=document.createElement("div");
    preview.className="preview-btn";
    preview.textContent="プレビュー";
    preview.onclick=(ev)=>{
      ev.stopPropagation();
      openSiteModal(e.url);
    };

    const btn=document.createElement("div"); btn.className="open-btn"; btn.textContent="開く";
    btn.onclick=(ev)=>{ev.stopPropagation(); location.href=directLink(e.url);};

    card.append(box,circle,dateText,preview,btn);
    wrap.appendChild(card);
  }
}

// 画像モーダル
let currentImages=[];
function openModal(hero, images, eventData){
  const img=document.getElementById("modal-img");
  const btnsWrap=document.getElementById("modal-btns");
  currentImages = [];

  const isGiftRanking = eventData && eventData.url && eventData.url.includes("gift_ranking");

  if(isGiftRanking){
    if(eventData.image){
      const heroImg = eventData.image.replace("mainbnr","hero");
      currentImages.push({src:heroImg,name:"Hero"});
    }
    const match = eventData.image.match(/gift_ranking\/([^/]+)/);
    if(match){
      const id = match[1];
      currentImages.push({src:`https://cdn.mirrativ.com/mirrorman-prod/assets/avatar/img/etc/gift_ranking/${id}/ranking/day_1.png`,name:"奇数日"});
      currentImages.push({src:`https://cdn.mirrativ.com/mirrorman-prod/assets/avatar/img/etc/gift_ranking/${id}/ranking/day_2.png`,name:"偶数日"});
    }
  }else{
    if(hero) currentImages.push({src:hero,name:"Hero"});
    for(const key of ["featured_reward","map","topic","topic2","emomorun"]){
      if(images && images[key]) currentImages.push({src:images[key],name:key});
    }
  }

  if(currentImages.length===0) return;

  btnsWrap.innerHTML="";
  currentImages.forEach((item,index)=>{
    const b=document.createElement("button");
    b.textContent=item.name;
    if(index===0) b.classList.add("active");
    b.onclick=()=>{
      loadModalImage(item.src);
      btnsWrap.querySelectorAll("button").forEach(bt=>bt.classList.remove("active"));
      b.classList.add("active");
    };
    btnsWrap.appendChild(b);
  });

  loadModalImage(currentImages[0].src);
  document.getElementById("modal").style.display="flex";
}
function loadModalImage(src){
  const loader=document.getElementById("modal-loader");
  const img=document.getElementById("modal-img");
  loader.style.display="block";
  img.style.display="none";
  img.onload=()=>{loader.style.display="none"; img.style.display="block";};
  img.src=proxyImage(src);
}

function closeModal(){document.getElementById("modal").style.display="none";}

document.addEventListener("keydown",e=>{
  if(e.key==="Escape"){
    closeModal();
    closeSiteModal();
  }
});

// スケジュールロード
loadSchedule();

// スクショ防止
document.addEventListener('contextmenu',e=>e.preventDefault());
document.addEventListener('selectstart',e=>e.preventDefault());
document.addEventListener('copy',e=>e.preventDefault());
document.addEventListener('keydown',e=>{
  if(e.ctrlKey && ["c","C","s","S","p","P"].includes(e.key)){
    e.preventDefault();
    document.getElementById("screenshot-warning").style.display="flex";
    setTimeout(()=>document.getElementById("screenshot-warning").style.display="none",3000);
  }
});
</script>
</body>
</html>