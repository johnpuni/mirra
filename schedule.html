<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Mirrativ Event Schedule</title>
<style>
body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background:#0e0e11;
  color:#fff;
  margin:0;
  padding:0;
}
h1{
  text-align:center;
  margin:20px 0;
}
#schedule{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:14px;
  padding:16px;
}
.card{
  background:#1a1b20;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 6px 14px rgba(0,0,0,.4);
  display:flex;
  flex-direction:column;
  align-items:center;
}
.image-box{
  width:100%;
  aspect-ratio:1/1;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  position:relative;
  border-radius:12px 12px 0 0;
  overflow:hidden;
}
.image-box img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.status{
  position:absolute;
  top:6px;
  left:6px;
  background:rgba(255,165,0,0.9);
  padding:2px 6px;
  border-radius:6px;
  font-size:12px;
  font-weight:bold;
}
.time{
  padding:8px;
  font-size:12px;
  text-align:center;
  opacity:.8;
  width:100%;
}
.open-btn{
  margin:6px;
  padding:8px 12px;
  font-size:14px;
  background:#ff9800;
  border:none;
  border-radius:8px;
  cursor:pointer;
  color:#000;
  font-weight:bold;
  transition:0.2s;
}
.open-btn:hover{
  background:#ffc107;
}

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
#modal{
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.9);
  align-items:center;
  justify-content:center;
  z-index:1000;
}
#modal-img{
  max-width:90%;
  max-height:90%;
  border-radius:12px;
}
#modal-close{
  position:absolute;
  top:20px;
  right:20px;
  font-size:24px;
  font-weight:bold;
  cursor:pointer;
  color:#fff;
}
</style>
</head>
<body>
<h1>ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h1>
<div id="schedule"></div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal">
  <span id="modal-close">&times;</span>
  <img id="modal-img" src="">
</div>

<script>
// ðŸ” ç”»åƒãƒ—ãƒ­ã‚­ã‚·ï¼ˆCORSå¯¾ç­–ï¼‰
function proxyImage(url){
  return "https://images.weserv.nl/?url=" + encodeURIComponent(url.replace(/^https?:\/\//,""));
}

// ðŸ”— Mirrativç›´é€šãƒªãƒ³ã‚¯
function directLink(url){
  return "mirr://webview/window/open?url=" + encodeURIComponent(url);
}

// ðŸ“¦ JSONèª­ã¿è¾¼ã¿
async function loadSchedule(){
  const listRes = await fetch("schedule/index.json");
  const files = await listRes.json();
  let events = [];

  for(const file of files){
    const res = await fetch("schedule/"+file);
    const data = await res.json();
    events = events.concat(data);
  }

  render(events);
}

// ðŸ–¼ æç”»
function render(events){
  const wrap = document.getElementById("schedule");
  const now = new Date();

  // é‡è¤‡URLãƒ»ç”»åƒãƒ»æ—¥ä»˜ã‚’é™¤å¤–
  const seen = new Set();
  const filtered = events.filter(e=>{
    const key = e.url+"|"+e.image+"|"+e.start+"|"+e.end;
    if(seen.has(key)) return false;
    seen.add(key);
    return true;
  });

  filtered.sort((a,b)=> new Date(a.start)-new Date(b.start));

  filtered.forEach(e=>{
    const card = document.createElement("div");
    card.className="card";

    const box = document.createElement("div");
    box.className="image-box";

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    const startDate = new Date(e.start);
    const endDate = new Date(e.end);
    let statusText="";
    if(now < startDate) statusText="é–‹å§‹ã¾ã§"+Math.ceil((startDate-now)/(1000*60*60*24))+"æ—¥";
    else if(now > endDate) statusText="çµ‚äº†";
    else statusText="é–‹å‚¬ä¸­";

    const statusDiv=document.createElement("div");
    statusDiv.className="status";
    statusDiv.textContent=statusText;
    box.appendChild(statusDiv);

    // ç”»åƒè¡¨ç¤ºï¼ˆä¸€è¦§: catalog_banner.pngï¼‰
    if(e.image){
      const img=document.createElement("img");
      img.src=e.image; // ä¸€è¦§ã¯banner
      box.appendChild(img);

      // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆhero.pngï¼‰
      box.onclick=()=>{
        document.getElementById("modal-img").src=e.image.replace("catalog_banner.png","hero.png");
        document.getElementById("modal").style.display="flex";
      }
    }else{
      box.textContent="No Image";
    }

    const time=document.createElement("div");
    time.className="time";
    time.textContent=startDate.toLocaleDateString()+" ï½ž "+endDate.toLocaleDateString();

    const openBtn=document.createElement("button");
    openBtn.className="open-btn";
    openBtn.textContent="é–‹ã";
    openBtn.onclick=()=> location.href=directLink(e.url);

    card.append(box,time,openBtn);
    wrap.appendChild(card);
  });
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
document.getElementById("modal-close").onclick=()=>{
  document.getElementById("modal").style.display="none";
}

loadSchedule();
</script>
</body>
</html>
