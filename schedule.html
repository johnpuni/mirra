<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Mirrativ Event Schedule</title>

<style>
body{
  font-family: system-ui, sans-serif;
  background:#0e0e11;
  color:#fff;
  margin:0;
}
h1{text-align:center;margin:20px 0}

#tabs{
  display:flex;
  justify-content:center;
  flex-wrap:wrap;
  gap:10px;
  margin-bottom:10px;
}
.tab{
  padding:6px 12px;
  background:#1a1b20;
  border-radius:999px;
  cursor:pointer;
  font-size:14px;
}
.tab.active{background:#3b82f6}

#schedule{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px;
  padding:16px;
}
@media(max-width:900px){
  #schedule{grid-template-columns:repeat(3,1fr);}
}

.card{
  background:#1a1b20;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 6px 14px rgba(0,0,0,.4);
}

.image-box{
  aspect-ratio:1/1;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  background:#000;
}
.image-box img{
  max-width:100%;
  max-height:100%;
  object-fit:contain;
}

.time{
  text-align:center;
  padding:6px;
  font-size:12px;
  opacity:.85;
}

.status{
  text-align:center;
  font-size:12px;
  padding-bottom:8px;
}
.running{color:#22c55e}
.future{color:#38bdf8}
.ended{color:#888}
</style>
</head>
<body>

<h1>イベントスケジュール</h1>
<div id="tabs"></div>
<div id="schedule"></div>

<script>
const proxy = u=>"https://images.weserv.nl/?url="+encodeURIComponent(u.replace(/^https?:\/\//,''));
const direct = u=>"mirr://webview/window/open?url="+encodeURIComponent(u);

let allEvents=[], currentMonth="";

async function load(){
  const files=await fetch("schedule/index.json").then(r=>r.json());
  for(const f of files){
    const data=await fetch("schedule/"+f).then(r=>r.json());
    allEvents.push(...data);
  }

  // 重複排除
  const seen=new Set();
  allEvents=allEvents.filter(e=>{
    const key=e.url+e.image+e.start+e.end;
    if(seen.has(key))return false;
    seen.add(key); return true;
  });

  buildTabs();
}

function buildTabs(){
  const months=[...new Set(allEvents.map(e=>e.start.slice(0,7)))].sort().reverse();
  const tabs=document.getElementById("tabs");
  tabs.innerHTML="";
  months.forEach(m=>{
    const t=document.createElement("div");
    t.className="tab";
    t.textContent=m;
    t.onclick=()=>render(m);
    tabs.appendChild(t);
  });
  render(months[0]);
}

function render(month){
  currentMonth=month;
  [...document.querySelectorAll(".tab")].forEach(t=>{
    t.classList.toggle("active",t.textContent===month);
  });

  const list=document.getElementById("schedule");
  list.innerHTML="";
  const now=new Date();

  allEvents.filter(e=>e.start.startsWith(month))
  .sort((a,b)=>new Date(a.start)-new Date(b.start))
  .forEach(e=>{
    const s=new Date(e.start), end=new Date(e.end);
    let status="future", label="開催予定";
    if(now>=s && now<=end){status="running";label="開催中";}
    if(now>end){status="ended";label="終了";}

    const card=document.createElement("div");
    card.className="card";

    const box=document.createElement("div");
    box.className="image-box";
    box.onclick=()=>location.href=direct(e.url);

    if(e.image){
      const img=document.createElement("img");
      img.src=proxy(e.image);
      box.appendChild(img);
    }else{
      box.textContent="No Image";
    }

    const time=document.createElement("div");
    time.className="time";
    time.textContent=s.toLocaleDateString()+" ～ "+end.toLocaleDateString();

    const st=document.createElement("div");
    st.className="status "+status;
    st.textContent=label;

    card.append(box,time,st);
    list.appendChild(card);
  });
}

load();
</script>
</body>
</html>
