<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Mirrativ Event Schedule</title>
<style>
body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background:#0e0e11;
  color:#fff;
  margin:0;
  padding:0;
}
h1{
  text-align:center;
  margin:20px 0;
}
.version{
  text-align:center;
  font-size:12px;
  opacity:.6;
  margin-bottom:10px;
}
.tabs{
  display:flex;
  justify-content:center;
  gap:10px;
  margin-bottom:10px;
  flex-wrap:wrap;
}
.tab{
  padding:6px 12px;
  border-radius:6px;
  cursor:pointer;
  background:#222;
  transition:0.2s;
}
.tab.active{
  background:#ff9800;
}
#schedule{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:14px;
  padding:16px;
}
.card{
  background:#1a1b20;
  border-radius:14px;
  overflow:hidden;
  box-shadow:0 6px 14px rgba(0,0,0,.4);
  display:flex;
  flex-direction:column;
}
.image-box{
  position:relative;
  aspect-ratio:1/1;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  overflow:hidden;
}
.image-box img{
  width:100%;
  height:100%;
  object-fit:cover;
  transition: transform 0.2s;
}
.image-box:hover img{
  transform: scale(1.05);
}
.status{
  position:absolute;
  top:6px;
  left:6px;
  padding:2px 6px;
  border-radius:4px;
  font-size:11px;
  color:#fff;
  background:rgba(0,0,0,0.6);
  font-weight:bold;
}
.time{
  padding:6px;
  font-size:12px;
  text-align:center;
  opacity:.8;
}
.open-btn{
  margin:6px;
  padding:4px 6px;
  font-size:12px;
  background:#ff9800;
  border:none;
  border-radius:6px;
  cursor:pointer;
  color:#000;
  font-weight:bold;
  transition:0.2s;
}
.open-btn:hover{
  background:#ffc107;
}
.modal{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,0.8);
  z-index:999;
}
.modal-content{
  position:relative;
  max-width:90%;
  max-height:90%;
}
.modal-content img{
  width:100%;
  height:auto;
  border-radius:12px;
}
.close-btn{
  position:absolute;
  top:-10px;
  right:-10px;
  background:#ff9800;
  border:none;
  border-radius:50%;
  width:28px;
  height:28px;
  cursor:pointer;
  font-weight:bold;
  font-size:16px;
}
</style>
</head>
<body>
<h1>„Ç§„Éô„É≥„Éà„Çπ„Ç±„Ç∏„É•„Éº„É´</h1>
<div class="version">„Éê„Éº„Ç∏„Éß„É≥ 1.0.2</div>
<div class="tabs" id="month-tabs"></div>
<div id="schedule"></div>

<!-- „É¢„Éº„ÉÄ„É´ -->
<div class="modal" id="modal">
  <div class="modal-content">
    <button class="close-btn" id="close-modal">√ó</button>
    <img id="modal-img" src="">
  </div>
</div>

<script>
// üîÅ ÁîªÂÉè„Éó„É≠„Ç≠„Ç∑ÔºàCORSÂØæÁ≠ñÔºâ
function proxyImage(url){ return url; } // ÂøÖË¶Å„Å™„Çâ„Éó„É≠„Ç≠„Ç∑‰Ωø„ÅÜ

// üîó MirrativÁõ¥ÈÄö„É™„É≥„ÇØ
function directLink(url){
  return "mirr://webview/window/open?url=" + encodeURIComponent(url);
}

// üì¶ JSONË™≠„ÅøËæº„Åø
async function loadSchedule(){
  const listRes = await fetch("schedule/index.json");
  const files = await listRes.json();

  let events = [];

  for(const file of files){
    const res = await fetch("schedule/" + file);
    const data = await res.json();
    events = events.concat(data);
  }

  // ÂêåURL„ÉªÂêåÊó•‰ªò„ÉªÂêåÁîªÂÉè„ÅÆÈáçË§áÊéíÈô§
  const uniqueMap = {};
  events = events.filter(e=>{
    const key = e.url+"|"+e.start+"|"+e.image;
    if(uniqueMap[key]) return false;
    uniqueMap[key]=true;
    return true;
  });

  render(events);
}

// üñº ÊèèÁîª
function render(events){
  const wrap = document.getElementById("schedule");
  wrap.innerHTML="";

  const now = new Date();
  const monthSet = new Set();
  events.forEach(e=>{
    const d = new Date(e.start);
    monthSet.add(d.getFullYear()+"-"+(d.getMonth()+1));
  });
  const months = Array.from(monthSet).sort((a,b)=> a.localeCompare(b));

  const tabWrap = document.getElementById("month-tabs");
  tabWrap.innerHTML="";
  months.forEach((m,i)=>{
    const tab = document.createElement("div");
    tab.className="tab";
    tab.textContent=m;
    if(i===months.length-1) tab.classList.add("active"); // ÊúÄÊñ∞Êúà„ÇíÂàùÊúüË°®Á§∫
    tab.onclick=()=> {
      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      tab.classList.add("active");
      displayMonth(events, m);
    }
    tabWrap.appendChild(tab);
  });

  displayMonth(events, months[months.length-1]); // ÂàùÊúüË°®Á§∫ÊúÄÊñ∞Êúà
}

// Êúà„Åî„Å®Ë°®Á§∫
function displayMonth(events, month){
  const wrap = document.getElementById("schedule");
  wrap.innerHTML="";
  const now = new Date();

  const filtered = events.filter(e=>{
    const d = new Date(e.start);
    const key = d.getFullYear()+"-"+(d.getMonth()+1);
    return key===month;
  });

  filtered.sort((a,b)=> new Date(a.start)-new Date(b.start));

  filtered.forEach(e=>{
    const card = document.createElement("div");
    card.className="card";

    const box = document.createElement("div");
    box.className="image-box";

    // „Çπ„ÉÜ„Éº„Çø„ÇπË°®Á§∫
    const startDate = new Date(e.start);
    const endDate = new Date(e.end);
    let statusText="";
    if(now < startDate) statusText="ÈñãÂßã„Åæ„Åß"+Math.ceil((startDate-now)/(1000*60*60*24))+"Êó•";
    else if(now > endDate) statusText="ÁµÇ‰∫Ü";
    else statusText="ÈñãÂÇ¨‰∏≠";

    const statusDiv=document.createElement("div");
    statusDiv.className="status";
    statusDiv.textContent=statusText;
    box.appendChild(statusDiv);

    // ÁîªÂÉèË°®Á§∫Ôºà‰∏ÄË¶ß: catalog_banner.pngÔºâ
    if(e.image){
      const img = document.createElement("img");
      img.src=e.image.replace("catalog_banner.png","catalog_hero.png"); // hero.png„ÇíÂà•Âêç„Å´
      box.appendChild(img);

      // „ÇØ„É™„ÉÉ„ÇØ„Åß„É¢„Éº„ÉÄ„É´Ôºàhero.pngÔºâ
      box.onclick=()=>{
        document.getElementById("modal-img").src=e.image.replace("catalog_banner.png","hero.png");
        document.getElementById("modal").style.display="flex";
      }
    }

    const time = document.createElement("div");
    time.className="time";
    time.textContent=startDate.toLocaleDateString()+" ÔΩû "+endDate.toLocaleDateString();

    const openBtn=document.createElement("button");
    openBtn.className="open-btn";
    openBtn.textContent="Èñã„Åè";
    openBtn.onclick=()=> location.href=directLink(e.url);

    card.append(box,time,openBtn);
    wrap.appendChild(card);
  });
}

// „É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã
document.getElementById("close-modal").onclick=()=> document.getElementById("modal").style.display="none";
document.getElementById("modal").onclick=(e)=>{if(e.target.id==="modal") document.getElementById("modal").style.display="none";}

loadSchedule();
</script>
</body>
</html>
