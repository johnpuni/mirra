<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mirrativ 入室</title>
<style>
  body{margin:0;background:#0f1115;color:#fff;font-family:system-ui,-apple-system,"Segoe UI",sans-serif}
  header{position:sticky;top:0;background:#141823;border-bottom:1px solid #222;padding:12px 14px}
  h1{margin:0;font-size:16px}
  .wrap{max-width:860px;margin:0 auto;padding:14px}
  .card{background:#151a26;border:1px solid #222;border-radius:14px;padding:12px;margin:10px 0}
  textarea,input{width:100%;box-sizing:border-box;background:#0f1320;color:#fff;border:1px solid #2a3147;border-radius:12px;padding:10px;font-size:15px}
  textarea{min-height:120px;resize:vertical}
  button{border:0;border-radius:12px;padding:10px 12px;font-size:15px;background:#3b82f6;color:#fff}
  button.sub{background:#263045}
  button.danger{background:#ef4444}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row>*{flex:1}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .tab{padding:8px 10px;border-radius:999px;border:1px solid #2a3147;background:#0f1320;color:#cbd5e1;cursor:pointer}
  .tab.active{background:#fbbf24;border-color:#fbbf24;color:#111827;font-weight:700}
  .list{display:grid;gap:10px}
  .item{display:flex;gap:8px;align-items:center;justify-content:space-between;background:#0f1320;border:1px solid #2a3147;border-radius:12px;padding:10px}
  .meta{display:flex;flex-direction:column;gap:2px;min-width:0}
  .meta b{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta small{color:#94a3b8}
  .btns{display:flex;gap:8px;flex:0 0 auto}
</style>
</head>
<body>
<header>
  <h1>Mirrativ 入室（ユーザーIDだけ）</h1>
  <div class="tabs" id="tabs"></div>
</header>

<div class="wrap">
  <div class="card">
    <div style="color:#94a3b8;font-size:13px;line-height:1.6">
      ユーザーID（数字）を入れるだけ。配信中ならライブへ、配信してなければユーザーページへ飛びます。<br>
      ※アカウント切替はMirrativ側で行います（サイト側からは切替不可）。
    </div>
  </div>

  <div class="card">
    <div class="row">
      <input id="presetName" placeholder="プリセット名（例：メイン垢 / サブ垢用 / 複数垢勢）" />
      <button class="sub" id="savePreset">保存</button>
      <button class="danger" id="deletePreset">削除</button>
    </div>
    <div style="height:10px"></div>

    <textarea id="input" placeholder="例）120504262&#10;142306302&#10;127864062"></textarea>

    <div style="height:10px"></div>
    <div class="row">
      <button id="build">一覧を作る</button>
      <button class="sub" id="openAll">上から順に入室</button>
    </div>
    <div id="hint" style="margin-top:10px;color:#94a3b8;font-size:13px"></div>
  </div>

  <div class="card">
    <div style="font-weight:700;margin-bottom:8px">入室リスト</div>
    <div class="list" id="list"></div>
  </div>
</div>

<script>
const STORAGE_KEY = "mirrativ_enter_presets_v1";
const tabsEl = document.getElementById("tabs");
const presetNameEl = document.getElementById("presetName");
const inputEl = document.getElementById("input");
const listEl = document.getElementById("list");
const hintEl = document.getElementById("hint");

function loadPresets(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}")}catch{return{}} }
function savePresets(p){ localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); }

function toast(msg){
  hintEl.textContent = msg;
  clearTimeout(window.__t);
  window.__t=setTimeout(()=>hintEl.textContent="",1600);
}

function parseUserIds(){
  return inputEl.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(s=>s.replace(/[^\d]/g,"")).filter(Boolean);
}

function buildTabs(active){
  const presets = loadPresets();
  const names = Object.keys(presets);
  tabsEl.innerHTML = "";

  const makeTab = (name, isActive) => {
    const b=document.createElement("button");
    b.className="tab"+(isActive?" active":"");
    b.textContent=name;
    b.onclick=()=>{
      presetNameEl.value=name;
      inputEl.value=presets[name]||"";
      buildTabs(name);
      renderList(parseUserIds());
    };
    return b;
  };

  tabsEl.appendChild(makeTab("（未保存）", !active));
  for(const n of names) tabsEl.appendChild(makeTab(n, active===n));
}

function renderList(ids){
  listEl.innerHTML="";
  if(ids.length===0){
    listEl.innerHTML=`<div style="color:#94a3b8">ユーザーIDを入れて「一覧を作る」</div>`;
    return;
  }

  for(const id of ids){
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`
      <div class="meta">
        <b>ユーザーID: ${id}</b>
        <small>配信中ならライブへ自動入室</small>
      </div>
      <div class="btns">
        <button class="sub" data-profile="${id}">プロフィール</button>
        <button data-enter="${id}">入室</button>
      </div>
    `;
    listEl.appendChild(div);
  }

  listEl.querySelectorAll("button[data-profile]").forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.getAttribute("data-profile");
      window.open(`https://www.mirrativ.com/user/${id}`, "_blank", "noopener");
    };
  });

  listEl.querySelectorAll("button[data-enter]").forEach(btn=>{
    btn.onclick=()=> enterByUserId(btn.getAttribute("data-enter"));
  });
}

async function enterByUserId(userId){
  try{
    toast("確認中...");
    // Pages Functionに投げる（ここが user_id→live_id 解決）
    const r = await fetch(`/resolve?user_id=${encodeURIComponent(userId)}`, { cache: "no-store" });
    if(!r.ok) throw new Error("resolve failed");
    const data = await r.json();
    const url = data.url || `https://www.mirrativ.com/user/${userId}`;
    window.open(url, "_blank", "noopener");
    toast(data.mode === "live" ? "ライブへ入室！" : "配信してないのでユーザーへ");
  }catch(e){
    // 失敗したら安全にユーザーページへ
    window.open(`https://www.mirrativ.com/user/${userId}`, "_blank", "noopener");
    toast("取得失敗→ユーザーページへ");
  }
}

document.getElementById("build").onclick=()=>{
  renderList(parseUserIds());
  toast("一覧更新！");
};

document.getElementById("savePreset").onclick=()=>{
  const name=presetNameEl.value.trim();
  if(!name) return toast("プリセット名入れて！");
  const presets=loadPresets();
  presets[name]=inputEl.value;
  savePresets(presets);
  buildTabs(name);
  toast("保存した！");
};

document.getElementById("deletePreset").onclick=()=>{
  const name=presetNameEl.value.trim();
  if(!name) return toast("削除する名前入れて！");
  const presets=loadPresets();
  delete presets[name];
  savePresets(presets);
  presetNameEl.value="";
  buildTabs(null);
  toast("削除した！");
};

document.getElementById("openAll").onclick=async ()=>{
  const ids=parseUserIds();
  if(ids.length===0) return toast("空だよ！");
  // iOSのポップアップブロック回避のため、間隔を空ける
  let i=0;
  const timer=setInterval(()=>{
    if(i>=ids.length){ clearInterval(timer); toast("完了！"); return; }
    enterByUserId(ids[i]);
    i++;
  }, 700);
};

buildTabs(null);
renderList(parseUserIds());
</script>
</body>
</html>