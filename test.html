<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Mirrativ Custom Web Player</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; }
        .container { display: flex; gap: 20px; padding: 20px; }
        #video-container { flex: 2; }
        #sidebar { flex: 1; display: flex; flex-direction: column; height: 90vh; }
        #comments, #gifts { overflow-y: auto; background: #2a2a2a; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
        #comments { height: 60%; }
        #gifts { height: 30%; }
        .hidden { display: none; }
        video { width: 100%; border-radius: 8px; }
        .comment-item { margin-bottom: 8px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 4px; }
    </style>
</head>
<body>

<div>
    <input type="text" id="userId" placeholder="User IDを入力 (例: 110544066)">
    <button onclick="startWatch()">視聴開始</button>
</div>

<div class="container">
    <div id="video-container">
        <video id="video" controls></video>
    </div>

    <div id="sidebar">
        <button onclick="toggleSection('comments')">コメント表示切替</button>
        <div id="comments"></div>
        
        <button onclick="toggleSection('gifts')">ギフト表示切替</button>
        <div id="gifts"></div>
    </div>
</div>

<script>
async function startWatch() {
    const userId = document.getElementById('userId').value;
    
    // 1. Live IDの取得
    const historyRes = await fetch(`YOUR_PROXY_URL/api/live/live_history?user_id=${userId}`);
    const historyData = await historyRes.json();
    const liveId = historyData.lives[0].live_id;

    // 2. ストリーミングURLの取得
    const streamRes = await fetch(`YOUR_PROXY_URL/api/live/get_streaming_url?live_id=${liveId}`);
    const streamData = await streamRes.json();
    const hlsUrl = streamData.streaming_url_hls;

    // 3. 動画再生 (Hls.js)
    const video = document.getElementById('video');
    if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(hlsUrl);
        hls.attachMedia(video);
        video.play();
    }

    // 4. コメント・ギフトの定期取得開始
    setInterval(() => updateComments(liveId), 3000);
}

async function updateComments(liveId) {
    const res = await fetch(`YOUR_PROXY_URL/api/live/live_comments?live_id=${liveId}`);
    const data = await res.json();
    const container = document.getElementById('comments');
    container.innerHTML = data.comments.map(c => `
        <div class="comment-item">
            <img src="${c.user_icon_url}" width="20">
            <strong>${c.user_name} (Lv.${c.cheer_level}):</strong> ${c.comment}
        </div>
    `).join('');
}

function toggleSection(id) {
    document.getElementById(id).classList.toggle('hidden');
}
</script>
</body>
</html>
