<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Mirrativ GAS Viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { background: #121212; color: white; font-family: sans-serif; margin: 0; }
        .header { padding: 15px; background: #1e1e1e; display: flex; gap: 10px; }
        input { flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #444; background: #222; color: white; }
        button { padding: 8px 20px; background: #ff005c; border: none; color: white; border-radius: 5px; cursor: pointer; }
        .content { display: flex; height: calc(100vh - 60px); }
        #video-area { flex: 3; background: #000; display: flex; align-items: center; }
        #sidebar { flex: 1; border-left: 1px solid #333; overflow-y: auto; padding: 10px; }
        .comment { margin-bottom: 10px; font-size: 13px; border-bottom: 1px solid #222; padding-bottom: 5px; }
        video { width: 100%; }
    </style>
</head>
<body>

<div class="header">
    <input type="text" id="userId" placeholder="ユーザーID (例: 110544066)" value="110544066">
    <button onclick="startApp()">視聴開始</button>
</div>

<div class="content">
    <div id="video-area">
        <video id="video" controls autoplay></video>
    </div>
    <div id="sidebar">
        <div id="comment-list">ここにコメントが表示されます</div>
    </div>
</div>

<script>
    // ★ここに新しいGASのURLを貼り付けてください
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzM72STzd28KPYTZitJvn3tWi__CIk2Qg6ChyGbXd2evAmZs-yr4cvpx40i_7OFDgA/exec";

    async function apiRequest(path, params) {
        const query = new URLSearchParams({ path, ...params }).toString();
        const res = await fetch(`${GAS_URL}?${query}`, { redirect: 'follow' });
        return await res.json();
    }

    async function startApp() {
        const uid = document.getElementById('userId').value;
        try {
            // 1. Live ID取得
            const history = await apiRequest("/api/live/live_history", { user_id: uid });
            const liveId = history.lives[0].live_id;

            // 2. 配信URL取得
            const stream = await apiRequest("/api/live/get_streaming_url", { live_id: liveId });
            const video = document.getElementById('video');
            
            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(stream.streaming_url_hls);
                hls.attachMedia(video);
            }

            // 3. コメント取得ループ
            setInterval(async () => {
                const cData = await apiRequest("/api/live/live_comments", { live_id: liveId });
                const list = document.getElementById('comment-list');
                list.innerHTML = cData.comments.map(c => `
                    <div class="comment">
                        <strong style="color:#ffcc00">${c.user_name}</strong>: ${c.comment}
                    </div>
                `).join('');
            }, 3000);

        } catch (e) {
            alert("エラーが発生しました。GASの設定（全員に公開）を確認してください。");
        }
    }
</script>
</body>
</html>
