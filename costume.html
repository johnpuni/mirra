<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Mirrativ イベント衣装図鑑</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ===== ベースCSS（指定どおり） ===== */
body {
  background:#111;
  color:white;
  font-family:sans-serif;
  margin:0;
}

.top { padding:10px; background:#222 }
input { padding:6px; }
button { padding:6px 10px; margin-left:5px }

video { width:100%; max-height:40vh; background:black }

.controls { padding:8px; }
.panel { display:flex }
.box { flex:1; max-height:50vh; overflow-y:auto; padding:10px; display:none }

/* ===== 変数 ===== */
:root {
  --primary:#ff5a5f;
  --owned:#4caf50;
}

/* ===== Header ===== */
header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: #222;
  padding: 10px;
  border-bottom:1px solid #333;
}

h1 {
  margin: 0 0 8px;
  font-size: 1.1rem;
  color: var(--primary);
}

/* ===== Controls ===== */
.controls {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
}

.filter-group {
  display: flex;
  background: #333;
  border-radius: 20px;
  padding: 2px;
}

.filter-group button {
  border: none;
  background: none;
  color:#ccc;
  padding: 6px 12px;
  border-radius: 18px;
  font-size: .8rem;
}

.filter-group button.active {
  background: #111;
  color:white;
  font-weight: bold;
}

select {
  background:#111;
  color:white;
  border:1px solid #444;
  border-radius:8px;
  padding:6px;
}

/* ===== パーツアイコンフィルタ ===== */
.part-icons {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding: 6px 4px;
}

.part-btn {
  flex: 0 0 auto;
  width: 42px;
  height: 42px;
  background: #fff;
  border-radius: 10px;
  border: 2px solid transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 1px 4px rgba(0,0,0,.4);
}

.part-btn img {
  width: 26px;
  height: 26px;
  object-fit: contain;
  pointer-events:none;
}

.part-btn.active {
  border-color: var(--primary);
  background: #ffecec;
}

/* ===== Stats ===== */
#stats {
  margin: 10px;
  padding: 12px;
  background: #222;
  border-radius: 12px;
  font-weight: bold;
  border:1px solid #333;
}

/* ===== Grid ===== */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(100px,1fr));
  gap: 10px;
  padding: 10px;
}

.item {
  background: #1b1b1b;
  border-radius: 12px;
  padding: 6px;
  position: relative;
  border:1px solid #333;
}

.item.owned {
  border: 2px solid var(--owned);
}

.item img.main {
  width: 100%;
  aspect-ratio: 1/1;
  object-fit: contain;
}

/* カード内パーツアイコン */
.part-mini {
  position: absolute;
  bottom: 6px;
  right: 6px;
  width: 20px;
  height: 20px;
  padding: 2px;
  background: rgba(255,255,255,.9);
  border-radius: 6px;
}

/* ===== Modal ===== */
#modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index:1000;
}

#modalContent {
  background: #111;
  width: 90%;
  max-width: 420px;
  max-height: 85vh;
  overflow-y: auto;
  border-radius: 16px;
  padding: 16px;
  border:1px solid #333;
}

#modalContent img {
  max-width:100%;
}

.hero-thumb {
  width: 100%;
  margin-top: 8px;
  border-radius: 8px;
}
</style>
</head>

<body>

<header>
  <h1>Mirrativ 衣装図鑑</h1>

  <div class="controls">
    <div class="filter-group">
      <button id="btn-all" class="active" onclick="setOwned('all')">全て</button>
      <button id="btn-owned" onclick="setOwned('owned')">所持</button>
      <button id="btn-unowned" onclick="setOwned('unowned')">未所持</button>
    </div>

    <select id="rarityFilter" onchange="render()">
      <option value="all">レアリティ</option>
    </select>
  </div>

  <div id="partIcons" class="part-icons"></div>
</header>

<div id="stats">0 / 0 (0%)</div>
<div id="list" class="grid"></div>

<div id="modal" onclick="if(event.target.id==='modal')closeModal()">
  <div id="modalContent"></div>
</div>

<script>
const PART_ICON = 'https://cdn.mirrativ.com/mirrativ-prod-assets/img/closet/part_type_icon/';
let data = [];
let owned = JSON.parse(localStorage.getItem('ownedItems')||'{}');
let ownedMode = 'all';
let selectedPart = 'all';

fetch('./index_data.json',{cache:'no-store'})
.then(r=>r.json())
.then(j=>{
  data=j;
  initFilters();
  render();
  updateStats();
});

function initFilters(){
  const rarity = document.getElementById('rarityFilter');
  [...new Set(data.map(i=>i.rarity))].sort().forEach(r=>{
    rarity.innerHTML+=`<option value="${r}">★${r}</option>`;
  });

  const wrap=document.getElementById('partIcons');
  [...new Set(data.map(i=>i.part_type))].sort().forEach(p=>{
    const b=document.createElement('div');
    b.className='part-btn';
    b.innerHTML=`<img src="${PART_ICON}${p}.png">`;
    b.onclick=()=>{
      selectedPart = selectedPart===p?'all':p;
      document.querySelectorAll('.part-btn').forEach(x=>x.classList.remove('active'));
      if(selectedPart!=='all') b.classList.add('active');
      render();
    };
    wrap.appendChild(b);
  });
}

function setOwned(m){
  ownedMode=m;
  document.querySelectorAll('.filter-group button').forEach(b=>b.classList.remove('active'));
  document.getElementById('btn-'+m).classList.add('active');
  render();
}

function render(){
  const list=document.getElementById('list');
  list.innerHTML='';
  const r=document.getElementById('rarityFilter').value;

  data.forEach(i=>{
    const o=!!owned[i.name];
    if(ownedMode==='owned'&&!o)return;
    if(ownedMode==='unowned'&&o)return;
    if(selectedPart!=='all'&&i.part_type!==selectedPart)return;
    if(r!=='all'&&String(i.rarity)!==r)return;

    const d=document.createElement('div');
    d.className='item'+(o?' owned':'');
    d.innerHTML=`
      <img class="main" src="${i.image.original_url}" loading="lazy">
      <img class="part-mini" src="${PART_ICON}${i.part_type}.png">
    `;
    d.onclick=()=>openItem(i);
    list.appendChild(d);
  });
}

function openItem(i){
  const eid=i.event_ids[0];
  const hero=i.hero?.[eid]?.original_url;
  const o=!!owned[i.name];

  modalContent.innerHTML=`
    <img src="${i.image.original_url}">
    <h3>${i.name}</h3>
    <p>
      ★${i.rarity}
      <img src="${PART_ICON}${i.part_type}.png" style="width:22px;vertical-align:middle;margin-left:6px">
    </p>
    <button onclick="toggleOwned('${i.name}')">${o?'所持済み':'未所持 → 所持'}</button>
    ${hero?`<img src="${hero}" class="hero-thumb" onclick="showHero(${eid})">`:''}
  `;
  modal.style.display='flex';
}

function showHero(id){
  modalContent.innerHTML=`
    <button onclick="closeModal()">← 戻る</button>
    <div class="grid">
      ${data.filter(i=>i.event_ids.includes(id)).map(i=>`
        <div class="item" onclick='openItem(${JSON.stringify(i)})'>
          <img class="main" src="${i.image.original_url}">
        </div>
      `).join('')}
    </div>`;
}

function toggleOwned(n){
  owned[n]=!owned[n];
  localStorage.setItem('ownedItems',JSON.stringify(owned));
  closeModal(); render(); updateStats();
}

function updateStats(){
  const t=data.length;
  const o=data.filter(i=>owned[i.name]).length;
  stats.textContent=`${o} / ${t} (${Math.round(o/t*100)}%)`;
}

function closeModal(){ modal.style.display='none'; }

if('serviceWorker'in navigator){
  navigator.serviceWorker.register('./sw.js',{updateViaCache:'none'});
}
</script>

</body>
</html>
